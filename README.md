# Rujira

## Running

    RUJIRA_DEBUG=true RUJIRA_URL=http://localhost:8080 RUJIRA_TOKEN=<JIRA_ACCESS_TOKEN> bundle exec ./bin/console

## Usage in the code

    project = random_name
    Rujira::Api::ServerInfo.get
    name = Rujira::Api::Myself.get['name']
    Rujira::Api::Project.create do
      data key: project.to_s,
           name: project.to_s,
           projectTypeKey: 'software',
           lead: 'root'
    end
    Rujira::Api::Project.get project.to_s
    Rujira::Api::Issue.create do
      data fields: {
        project: { key: project.to_s },
        summary: 'BOT: added a new feature.',
        description: 'This task was generated by the bot when creating changes in the repository.',
        issuetype: { name: 'Task' }
      }
      params updateHistory: true
    end
    Rujira::Api::Issue.watchers "#{project}-1", name
    Rujira::Api::Issue.get "#{project}-1"
    result = Rujira::Api::Search.get do
      data jql: "project = #{project} and status IN (\"To Do\", \"In Progress\") ORDER BY issuekey",
           maxResults: 10,
           startAt: 0,
           fields: %w[id key]
    end
    Rujira::Api::Issue.comment "#{project}-1" do
      data body: 'Adding a new comment'
    end
    Rujira::Api::Issue.edit "#{project}-1" do
      data update: {
             labels: [{ add: 'bot' }, { remove: 'some' }]
           },
           fields: {
             assignee: { name: name },
             summary: 'This is a shorthand for a set operation on the summary field'
           }
    end
    result['issues'].each do |issue|
      Rujira::Api::Issue.del issue['id'] do
        params deleteSubtasks: true
      end
    end

## Rake tasks

    require 'rujira/tasks/jira'
    Rujira::Tasks::Jira.new

    rake jira:issue:whoami
    rake jira:issue:create -- '--project=ITMG' \
        '--summary=The short summary information' \
        '--description=The base description of task' \
        '--issuetype=Task'
    rake jira:issue:search -- '-q project = ITMG'
    rake jira:issue:attach -- '--file=upload.png' '--issue=ITMG-1'

## Testing

### Run the instance of jira

    docker compose up -d
    open http://localhost:8080

### Example with Curl

    curl -H "Authorization: Bearer <JIRA_ACCESS_TOKEN>" 'http://localhost:8080/rest/api/2/search?expand=summary'
    curl -vv -X POST --data '"some"' -H "Authorization: Bearer <JIRA_ACCESS_TOKEN>" -H "Content-Type: application/json" 'http://localhost:8080/rest/api/2/issue/ITMG-70/watchers'
    curl -D- -F "file=@upload.png" -X POST -H "X-Atlassian-Token: nocheck" \
        -H "Authorization: Bearer <JIRA_ACCESS_TOKEN>" 'http://localhost:8080/rest/api/2/issue/ITMG-70/attachments'
